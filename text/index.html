<!DOCTYPE html>
<html lang="fa" dir="rtl" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HugeRTE - ویرایشگر غول‌پیکر متن</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.rtl.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.tiny.cloud/1/lbzw63rnj4mroj0udlfoeszze1nio5xk07y0xhn1sdq3ndgq/tinymce/6.8.6-46/tinymce.min.js" referrerpolicy="origin"></script>
  <script src="https://cdn.tiny.cloud/1/lbzw63rnj4mroj0udlfoeszze1nio5xk07y0xhn1sdq3ndgq/tinymce/6/langs/fa.js" referrerpolicy="origin"></script>
  <style>
    body { font-family: Vazirmatn, sans-serif; }
    .tab-actions { margin-right: 1rem; cursor: pointer; }
  </style>
</head>
<body>
<div class="page">
  <div class="page-wrapper">
    <div class="container-xl py-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="card-title"><i class="ti ti-edit me-2"></i>ویرایشگر HugeRTE حرفه‌ای</h3>
          <div>
            <button id="print-content" class="btn btn-info btn-sm me-2"><i class="ti ti-printer"></i></button>
            <button id="download-html" class="btn btn-success btn-sm me-2"><i class="ti ti-download"></i></button>
            <button id="clear-content" class="btn btn-danger btn-sm me-2"><i class="ti ti-trash"></i></button>
            <button id="theme-toggle" class="btn btn-primary btn-sm"><i class="ti ti-moon"></i></button>
          </div>
        </div>

        <div class="card-body">
          <!-- مدیریت تب‌ها -->
          <ul class="nav nav-tabs" id="page-tabs"></ul>
          <div class="my-2 d-flex gap-2">
            <button id="add-page" class="btn btn-outline-primary btn-sm"><i class="ti ti-plus"></i> افزودن صفحه</button>
          </div>

          <!-- ادیتور -->
          <textarea id="hugerte-editor"></textarea>
          <div class="mt-3 text-muted text-end">ذخیره خودکار - HugeRTE</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- مودال تغییر نام صفحه -->
<div class="modal modal-blur fade" id="modal-rename" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <form id="rename-form">
        <div class="modal-header">
          <h5 class="modal-title">تغییر عنوان صفحه</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="new-title" class="form-control" placeholder="عنوان جدید..." required />
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">ذخیره</button>
          <button type="button" class="btn btn-link" data-bs-dismiss="modal">لغو</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  let currentPage = 1;
  let pageTitles = {1: "صفحه ۱"};

  function updateTabs() {
    $("#page-tabs").empty();
    Object.entries(pageTitles).forEach(([id, title]) => {
      const active = parseInt(id) === currentPage ? "active" : "";
      $("#page-tabs").append(`
        <li class="nav-item">
          <a class="nav-link ${active}" href="#" id="tab-${id}">
            ${title}
            <i class="ti ti-edit text-warning tab-actions rename-tab" data-id="${id}"></i>
            <i class="ti ti-x text-danger tab-actions remove-tab" data-id="${id}"></i>
          </a>
        </li>`);
    });
  }

  function switchPage(id) {
    if (parseInt(id) === currentPage) return;
    saveCurrentContent();
    currentPage = parseInt(id);
    updateTabs();
    tinymce.remove("#hugerte-editor");
    setTimeout(() => {
      initEditor(localStorage.getItem("hugertePage" + currentPage) || "");
    }, 100);
  }

  function saveCurrentContent() {
    const content = tinymce.get("hugerte-editor").getContent();
    localStorage.setItem("hugertePage" + currentPage, content);
  }

  function initEditor(content) {
    const theme = localStorage.getItem("hugerteTheme") || "dark";
    tinymce.init({
      selector: "#hugerte-editor",
      language: "fa",
      directionality: "rtl",
      height: 400,
      menubar: false,
      skin: theme === "dark" ? "oxide-dark" : "oxide",
      content_css: theme === "dark" ? "dark" : "default",
      plugins: "table fullscreen emoticons codesample media lists advlist link",
      toolbar: "undo redo | styleselect | bold italic underline | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist | table | emoticons codesample media | fullscreen",
      content_style: "body { font-family: Vazirmatn,sans-serif; font-size:14px; direction: rtl; text-align:right; }",
      setup: function (editor) {
        editor.on("init", function () {
          editor.setContent(content);
        });
        editor.on("change keyup", function () {
          saveCurrentContent();
        });
      }
    });
  }

  $(document).ready(function () {
    const theme = localStorage.getItem("hugerteTheme") || "dark";
    $("html").attr("data-bs-theme", theme);
    $("#theme-toggle").html(theme === "dark" ? '<i class="ti ti-sun"></i>' : '<i class="ti ti-moon"></i>');

    updateTabs();
    initEditor(localStorage.getItem("hugertePage" + currentPage) || "");

    $(document).on("click", ".nav-link", function () {
      const id = $(this).attr("id").split("-")[1];
      switchPage(id);
    });

    $("#add-page").click(function () {
      const id = Date.now();
      pageTitles[id] = "صفحه جدید";
      updateTabs();
      switchPage(id);
    });

    $(document).on("click", ".remove-tab", function (e) {
      e.stopPropagation();
      const id = $(this).data("id");
      if (Object.keys(pageTitles).length === 1) {
        alert("حداقل یک صفحه باید باقی بماند.");
        return;
      }
      if (confirm("آیا از حذف این صفحه مطمئنی؟")) {
        delete pageTitles[id];
        localStorage.removeItem("hugertePage" + id);
        if (parseInt(id) === currentPage) currentPage = parseInt(Object.keys(pageTitles)[0]);
        updateTabs();
        switchPage(currentPage);
      }
    });

    $(document).on("click", ".rename-tab", function (e) {
      e.stopPropagation();
      const id = $(this).data("id");
      $("#modal-rename").modal("show");
      $("#new-title").val(pageTitles[id]);
      $("#rename-form").off("submit").on("submit", function (event) {
        event.preventDefault();
        const newTitle = $("#new-title").val().trim();
        if (newTitle) {
          pageTitles[id] = newTitle;
          updateTabs();
          $("#modal-rename").modal("hide");
        }
      });
    });

    $("#clear-content").click(function () {
      if (confirm("مطمئنی که می‌خوای این صفحه پاک بشه؟")) {
        tinymce.get("hugerte-editor").setContent("");
        localStorage.removeItem("hugertePage" + currentPage);
      }
    });

    $("#download-html").click(function () {
      const content = tinymce.get("hugerte-editor").getContent();
      const blob = new Blob([content], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = (pageTitles[currentPage] || "page") + ".html";
      a.click();
      URL.revokeObjectURL(url);
    });

    $("#print-content").click(function () {
      const content = tinymce.get("hugerte-editor").getContent();
      const w = window.open("", "", "width=800,height=600");
      w.document.write(`<html><head><title>چاپ</title></head><body dir="rtl" style="font-family: Vazirmatn;">${content}</body></html>`);
      w.document.close();
      w.print();
    });

    $("#theme-toggle").click(function () {
      const current = $("html").attr("data-bs-theme");
      const next = current === "dark" ? "light" : "dark";
      $("html").attr("data-bs-theme", next);
      localStorage.setItem("hugerteTheme", next);
      $(this).html(next === "dark" ? '<i class="ti ti-sun"></i>' : '<i class="ti ti-moon"></i>');
      tinymce.remove("#hugerte-editor");
      setTimeout(() => initEditor(localStorage.getItem("hugertePage" + currentPage) || ""), 100);
    });
  });
</script>
</body>
</html>
